# AMWA BCP-xxx-01: NMOS Receiver Capabilities \[Work In Progress\]

In [IS-04][], a Receiver resource expresses the capabilities of a Receiver through attributes that identify constraints on streams of compatible Senders.

Receivers define a`"transport"` and `"format"`. These attributes express constraints that can be evaluated against the related attributes of a Sender and its Flow.

The Receiver `"caps"` object is provided as an extensible mechanism to define finer-grained constraints.

IS-04 itself defines `"caps"` attributes for `"media_types"` (since v1.1) and, for data Receivers, also  `"event_types"` (since v1.3). Both these attributes express constraints that can be evaluated against Flow attributes, as arrays whose elements define the alternatives that are acceptable. In each case, the constraint is satisfied when the target Flow attribute matches **any of** the enumerated alternatives.

When `"caps"` contains multiple attributes, i.e. both `"media_types"` and `"event_types"`, the Receiver indicates that it only accepts streams that satisfy **all of** (both!) the constraints.

This specification defines a new `"constraint_sets"` attribute for the Receiver `"caps"` object, which can also be combined with the existing ones. In common with the existing attributes, its value is an array of alternatives; this constraint is satisfied when **any of** its enumerated Constraint Sets are satisfied.

This specification defines a generic JSON syntax to express Constraint Sets made up of individual Parameter Constraints. The Constraint Set is satisfied if **all of** its Parameter Constraints are satisfied.

The representation of individual Parameter Constraints is consistent with the mechanism defined by [IS-05][] to constrain Sender and Receiver transport parameters at the **/constraints** endpoints, which Nodes and Controllers may also support.

The `"constraints_set"` attribute is listed in the Capabilities parameter register in [NMOS Parameter Registers][].

## Use of Normative Language

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [RFC 2119][RFC-2119].

## Defining Parameter Constraints

A specification for each Parameter Constraint MUST be listed in the Capabilities register in the [NMOS Parameter Registers][]. Each specification defines a unique identifier, the constraint type, and the target parameter, as follows.

### Parameter Constraint Identifiers

Each Parameter Constraint is given a unique identifier - a URN. Parameter Constraints defined by the AMWA have the form:
```
urn:x-nmos:cap:<category>:<constraint>
```

Two `<category>` names are initially defined, `format` for media-related constraints, and `transport` for transport-related constraints.

For example, `urn:x-nmos:cap:format:grain_rate` is a Parameter Constraint relating to the Grain rate of the stream, for example by targeting the  `grain_rate` attribute of an IS-04 Flow. (The concept of Grains is defined in the [JT-NM Reference Architecture][].)

The `<category>` name `meta` is reserved for [metadata related to Constraint Sets](#constraint-set-metadata).

### Parameter Constraint Types

The specification defines the JSON value type to which the constraint relates, which MUST be one of:
  * `string`
  * `integer`
  * `number`
  * `boolean`
  * `rational`
    * as per IS-04, a JSON object with an integer `"numerator"` and optional integer `"denominator"` (default: 1)
  * (TBC whether necessary) `array`
  * (TBC whether necessary) `object`

The type of the constraint defines which [Constraint Keywords](#constraint-keywords) are allowed when the Parameter Constraint is instantiated.

### Parameter Constraint Target

The specification defines the target parameter against which the constraint is to be evaluated, for example, the specific IS-04 Flow attribute or [SDP][] format-specific parameter.

Especially in the case of parameters carried in non-JSON formats, such as a transport file, the specification MUST also describe how to map the parameter value to one of the [supported JSON types](#parameter-constraint-types).

## Instantiating Parameter Constraints

The Receiver expresses its capabilities with respect to a particular Parameter Constraint by including the constraint's unique identifier as an attribute in a [Constraint Set](#constraint-sets) with an object value, the attributes of which depend on the [specified type](#parameter-constraint-types).

For example:

```json
"urn:x-nmos:cap:format:bit_depth": {
  "enum": [ 24, 20, 16 ]
}
```

## Constraint Keywords

### Common Constraint Keywords

The following attributes are allowed for all constraint types:
* (TBC whether necessary by prototyping activity) `type`, indicating the [specified type](#parameter-constraint-types) as a string value
* `enum` as an array value with one or more elements of the specified type
* (TBC) any means to indicate whether `null` or missing is acceptable?

### String Constraint Keywords

The following attribute is additionally allowed for `string` constraints:

* (TBC) `pattern`, a string value that is a regex pattern

### Integer and Number Constraint Keywords

The following attributes are additionally allowed for `integer` and `number` constraints:

* `minimum`, inclusive minimum, an integer or number as appropriate
* `maximum`, inclusive maximum, an integer or number as appropriate

### Boolean Constraint Keywords

Nothing additional

### Rational Constraint Keywords

The following attributes are additionally allowed for `rational` constraints:

* `minimum`, inclusive minimum, a `rational` value
* `maximum`, inclusive maximum, a `rational` value

### Array Constraint Keywords
(TBC)

The following attributes are additionally allowed for `array` constraints:

* `minItems`, the inclusive minimum number of elements, integer
* `maxItems`, the inclusive maximum number of elements, integer
* `numItems`, the acceptable numbers of elements, an array of integers
* `items`, a Parameter Constraint which all elements must satisfy, or an array of Parameter Constraints which must be satisfied one-to-one
* `contains`, a Parameter Constraint which must be satisfied by one or more elements

### Object Constraint Keywords
(TBC)

* `properties` to constrain specific attributes of the object?

## Constraint Sets

Constraint Sets are instantiated with one or more Parameter Constraints. The Constraint Set is satisfied if **all of** its Parameter Constraints are satisfied.

The Constraint Set is represented as a JSON object whose attributes are the Parameter Constraints.

The Receiver advertises a list of Constraint Sets as a JSON array of these objects, using the key `"constraint_sets"` in the `"caps"` object.

A [worked example](#worked-example) is given below.

(TBC) Should we permit Parameter Constraints that would be identical in all Constraint Sets to be instantiated as top-level `"caps"` attributes instead?

### Constraint Set Metadata

Additional metadata about each Constraint Set may be included using attributes listed in the Capabilities register in the [NMOS Parameter Registers][] with the following unique identifiers:
```
urn:x-nmos:cap:meta:<attribute>
```

For example, `urn:x-nmos:cap:meta:label` may be used to provide a human-readable name for the Constraint Set.

The identifier `urn:x-nmos:cap:meta:quality` enables the Receiver to indicate the relative quality of its listed Constraint Sets.

...

## Validating Parameter Constraints and Constraint Sets

This specification includes a JSON Schema for each [Parameter Constraint Type](#parameter-constraint-type) and for Constraint Sets and the `"constraint_sets"` attribute as a whole.

## Behaviour: Receivers

Receivers SHOULD express their capabilities as precisely as possible. However, this specification may not be sufficiently expressive to indicate every type of stream that a Receiver can or cannot consume successfully. It is entirely possible that a Receiver may fail to consume a stream even if the Receiver's advertised Constraint Sets indicate that it can.

The value of the `"constraint_sets"` attribute MUST be valid according to this specification. The value of all the Constraint Set attributes MUST be valid according to the relevant specification in the Capabilities register in the [NMOS Parameter Registers][].

The capabilities of a Receiver could change over its lifetime, for example, as a result of reconfiguration by some other means. The Receiver MUST reflect any change in its capabilities by updating the `"caps"` object as appropriate and [modifying the `"version"` attribute, as per IS-04](https://amwa-tv.github.io/nmos-discovery-registration/tags/v1.3/docs/2.1._APIs_-_Common_Keys.html#version).

...

## Behaviour: Controllers

Controllers MAY validate a Receiver's `"constraint_sets"` against the JSON schema included in this specification, before evaluating the Constraint Sets. Controllers MAY ignore the entire `"constraint_sets"` value if it does not match the schema.

Controllers are RECOMMENDED to evaluate only those Parameter Constraints whose unique identifiers they recognize.

...

## Worked Examples

### HD Video Receiver

A Receiver of ST 2110-20 Video with limited support for various frame rates:

```json
{
  ...
  "transport": "urn:x-nmos:transport:rtp",
  "format": "urn:x-nmos:format:video",
  "caps": {
    "media_types": [ "video/raw" ],
    "constraint_sets": [
      {
        "urn:x-nmos:cap:meta:label": "1080i",
        "urn:x-nmos:cap:format:color_sampling": {
          "enum": [ "YCbCr-4:2:2" ]
        },
        "urn:x-nmos:cap:format:frame_height": {
          "enum": [ 1080 ]
        },
        "urn:x-nmos:cap:format:frame_width": {
          "enum": [ 1920 ]
        },
        "urn:x-nmos:cap:format:grain_rate": {
          "enum": [
             { "numerator": 25 },
             { "numerator": 30000, "denominator": 1001 }
           ]
        },
        "urn:x-nmos:cap:format:interlace_mode": {
          "enum": [
            "interlaced_tff",
            "interlaced_bff",
            "interlaced_psf"
          ]
        }
      },
      {
        "urn:x-nmos:cap:meta:label": "1080p",
        "urn:x-nmos:cap:format:color_sampling": {
          "enum": [ "YCbCr-4:2:2" ]
        },
        "urn:x-nmos:cap:format:frame_height": {
          "enum": [ 1080 ]
        },
        "urn:x-nmos:cap:format:frame_width": {
          "enum": [ 1920 ]
        },
        "urn:x-nmos:cap:format:grain_rate": {
          "enum": [
             { "numerator": 25 },
             { "numerator": 30000, "denominator": 1001 },
             { "numerator": 50 },
             { "numerator": 60000, "denominator": 1001 }
           ]
        },
        "urn:x-nmos:cap:format:interlace_mode": {
          "enum": [ "progressive" ]
        }
      }
    ]
  }
}
```

[IS-04]: https://amwa-tv.github.io/nmos-discovery-registration/ "AMWA IS-04 NMOS Discovery and Registration Specification"

[IS-05]: https://amwa-tv.github.io/nmos-device-connection-management/ "AMWA IS-05 NMOS Device Connection Management Specification"

[JT-NM Reference Architecture]: https://jt-nm.org/RA-1.0/ "JT-NM Reference Architecture (RA) v1.0"

[NMOS Parameter Registers]: https://amwa-tv.github.io/nmos-parameter-registers "Common parameter values for AMWA NMOS Specifications"

[RFC-2119]: https://tools.ietf.org/html/rfc2119 "Key words for use in RFCs to Indicate Requirement Levels"

[SDP]: https://tools.ietf.org/html/rfc4566 "SDP: Session Description Protocol"

<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJTVjMyamRabEZ2S1dHZDE0Ijp7In
RleHQiOiIqIGBwYXR0ZXJuYCIsInN0YXJ0Ijo1MTQxLCJlbmQi
OjUxOTh9LCJIRWF1Q1NGSE8xYUpDeUdkIjp7InRleHQiOiIjIy
MgQXJyYXkgQ29uc3RyYWludHMiLCJzdGFydCI6NTc0MSwiZW5k
Ijo1NzcwfSwiU3Zwd0RVd0JrY3VSZU1zUiI6eyJ0ZXh0IjoiIy
MjIE9iamVjdCBDb25zdHJhaW50cyIsInN0YXJ0Ijo2Mjc4LCJl
bmQiOjYzMDh9LCJrSUc3dTdpczBoNk40VWhUIjp7InRleHQiOi
IqIGluY2x1ZGUgZXhwbGljaXQgYHR5cGVgIG9yIG5vdD8iLCJz
dGFydCI6NDc1MCwiZW5kIjo0ODg2fSwia01kWllKWkh3UUpWbE
xROCI6eyJ0ZXh0IjoiKiBgYXJyYXlgXG4gICogYG9iamVjdGAi
LCJzdGFydCI6MzUzOCwiZW5kIjozNjA4fSwiRmVBNHh1SDRQNU
hmeWJ5cCI6eyJ0ZXh0IjoiXCJtZWRpYV90eXBlc1wiOiBbIFwi
dmlkZW8vcmF3XCIgXSwiLCJzdGFydCI6OTQzNSwiZW5kIjo5ND
Y2fSwialdPUjdrZzk3WG1qZDRZdSI6eyJ0ZXh0IjoiVGhlIGlk
ZW50aWZpZXIgYHVybjp4LW5tb3M6Y2FwczptZXRhOnF1YWxpdH
lgIiwic3RhcnQiOjczODIsImVuZCI6NzQyNn0sIkRKU2lTazUx
d0xiTmNrZ3MiOnsic3RhcnQiOjcyMzQsImVuZCI6NzI2NSwidG
V4dCI6InVybjp4LW5tb3M6Y2FwOm1ldGE6PGF0dHJpYnV0ZT4i
fX0sImNvbW1lbnRzIjp7IlZNUDhhOFpETzdGSEJIQloiOnsiZG
lzY3Vzc2lvbklkIjoiU1YzMmpkWmxGdktXR2QxNCIsInN1YiI6
ImdoOjMxNzYxMTU4IiwidGV4dCI6Ik5vdGU6IGBtaW5MZW5ndG
hgIGFuZCBgbWF4TGVuZ3RoYCBjYW4gYmUgYWNjb21wbGlzaGVk
IHdpdGggcmVnZXggYHBhdHRlcm5gIiwiY3JlYXRlZCI6MTYwMj
c1ODU5ODcwNn0sIk54UzVsUE1uZk9vT0M2RWwiOnsiZGlzY3Vz
c2lvbklkIjoiSEVhdUNTRkhPMWFKQ3lHZCIsInN1YiI6ImdoOj
MxNzYxMTU4IiwidGV4dCI6IkJleW9uZCBzY29wZSBlbnRpcmVs
eT8gT3IgYWxsb3cgc29tZSBvciBhbGwgb2YgdGhlc2UgYXR0cm
lidXRlcz8iLCJjcmVhdGVkIjoxNjAyNzYwNzkwNzY4fSwiSmNU
b1dUNVNGcnZ3bU5QQSI6eyJkaXNjdXNzaW9uSWQiOiJTdnB3RF
V3QmtjdVJlTXNSIiwic3ViIjoiZ2g6MzE3NjExNTgiLCJ0ZXh0
IjoiQmV5b25kIHNjb3BlIG9yIG5vdD8iLCJjcmVhdGVkIjoxNj
AyNzYwODA3MzMyfSwiTWttakhybFhDS3hiTkJYaiI6eyJkaXNj
dXNzaW9uSWQiOiJrSUc3dTdpczBoNk40VWhUIiwic3ViIjoiZ2
g6MzE3NjExNTgiLCJ0ZXh0IjoiT3BlbiBxdWVzdGlvbiAtIGlm
IENvbnRyb2xsZXJzIGFyZSBSRUNPTU1FTkRFRCB0byBpZ25vcm
UgcGFyYW1ldGVyIGNvbnN0cmFpbnRzIHRoZXkgZG9uJ3QgcmVj
b2duaXplLCB3aHkgaXMgaXQgbmVjZXNzYXJ5PyIsImNyZWF0ZW
QiOjE2MDI3NjA4NTk3MjV9LCJMWG8wWmFscVZPMldHcTduIjp7
ImRpc2N1c3Npb25JZCI6ImtNZFpZSlpId1FKVmxMUTgiLCJzdW
IiOiJnaDozMTc2MTE1OCIsInRleHQiOiJCZXlvbmQgc2NvcGU/
IFNlZSBiZWxvdy4uLiIsImNyZWF0ZWQiOjE2MDI3NjEwMjg5Mz
F9LCJBWGg5Zk9qZzZkcEo2eDJmIjp7ImRpc2N1c3Npb25JZCI6
IkZlQTR4dUg0UDVIZnlieXAiLCJzdWIiOiJnaDo3MTU0MjEiLC
J0ZXh0IjoiV2hpbHN0IEkgY2FuIHNlZSB0aGlzIGJlaW5nIHVz
ZWZ1bCBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIEkgZG
8gd29uZGVyIGlmIGEgY2xpZW50IHdoaWNoIG9ic2VydmVzICd1
cm46eC1ubW9zOmNhcHMnIGJlaW5nIHByZXNlbnQgY291bGQgaW
dub3JlIHRoaXMgZW50aXJlbHkgYW5kIHVzZSBwdXJlbHkgdGhl
IG5ldyBjYXBzIGZvcm1hdCBpbiBwcmVmZXJlbmNlPyBUaGF0IH
dheSB0aGUgbWVkaWFfdHlwZXMgY291bGQgYmUgdGllZCB0byBv
dGhlciBjYXBzIHJhdGhlciB0aGFuIGFwcGx5aW5nIGdsb2JhbG
x5IGFjcm9zcyB0aGVtLiIsImNyZWF0ZWQiOjE2MDI4Mzk0NTM3
MTR9LCJ3TDZwNkVDVnk3S2tHcnV3Ijp7ImRpc2N1c3Npb25JZC
I6ImpXT1I3a2c5N1htamQ0WXUiLCJzdWIiOiJnaDozMTc2MTE1
OCIsInRleHQiOiJTZWUgZGlzY3Vzc2lvbiBhYm91dCB1c2luZy
BcInByaVwiIG9yIFwicHJlZlwiIG9yIHNvbWV0aGluZyBzaW1p
bGFyLi4uIiwiY3JlYXRlZCI6MTYwMzExMDg0NDc2Mn0sIkhWZ3
ozSkpDZUNKQ1FyV1ciOnsiZGlzY3Vzc2lvbklkIjoia0lHN3U3
aXMwaDZONFVoVCIsInN1YiI6ImdoOjMxNzYxMTU4IiwidGV4dC
I6Ikp1c3QgaW5jbHVkZSB0aGUgdHlwZSBpbiB0aGUgc3BlY2lm
aWNhdGlvbiBpbiB0aGUgUGFyYW1ldGVyIFJlZ2lzdGVycyIsIm
NyZWF0ZWQiOjE2MDMxMTE0Njc4Njh9LCJTYlVzVmt4OGhSbld4
SjNxIjp7ImRpc2N1c3Npb25JZCI6IkZlQTR4dUg0UDVIZnlieX
AiLCJzdWIiOiJnaDozMTc2MTE1OCIsInRleHQiOiJJJ2QgcmF0
aGVyIGtlZXAgdGhlIHJ1bGUgdGhhdCBhbGwgY29uc3RyYWludH
MgYXQgdGhlIHRvcCBsZXZlbCBvZiBgXCJjYXBzXCJgIG11c3Qg
YmUgc2F0aXNmaWVkLiBUaGUgYFwidXJuOngtbm1vczpjYXA6Zm
xvdzptZWRpYV90eXBlXCJgIGNvbnN0cmFpbnQgYWxsb3dzIENv
bnN0cmFpbnQgU2V0cyB0byBiZSB0aWVkIHRvIHNwZWNpZmljIG
1lZGlhIHR5cGVzPyIsImNyZWF0ZWQiOjE2MDMzNTkzODQ2NTF9
LCJLbDBCb0hheDJlQ1BDcTNnIjp7ImRpc2N1c3Npb25JZCI6Ik
ZlQTR4dUg0UDVIZnlieXAiLCJzdWIiOiJnaDo3MTU0MjEiLCJ0
ZXh0IjoiWWVzLCB3aXRoIHRoZSBwcm92aXNpb24gdGhhdCB5b3
UgYXJlIHBlcm1pdHRlZCB0byB1c2UgYHVybjp4LW5tb3M6Y2Fw
OmZsb3c6bWVkaWFfdHlwZWAgYWxvbmdzaWRlIHRoZSB0b3AgbG
V2ZWwgYG1lZGlhX3R5cGVzYCB0aGF0IHNvdW5kcyBmaW5lLiIs
ImNyZWF0ZWQiOjE2MDM0NTg2OTE2OTN9LCI3UEpwQm1QQWdINm
xLM1M2Ijp7ImRpc2N1c3Npb25JZCI6IkRKU2lTazUxd0xiTmNr
Z3MiLCJzdWIiOiJnaDozMTc2MTE1OCIsInRleHQiOiJJbiBvcm
RlciB0byBzaW1wbGlmeSB0aGUgSlNPTiBzY2hlbWEgZm9yIGEg
Q29uc3RyYWludCBTZXQgd2hpY2ggd2lsbCB1c2UgYHBhdHRlcm
5Qcm9wZXJ0aWVzYCB0byBtYXRjaCBQYXJhbWV0ZXIgQ29uc3Ry
YWludCBpZGVudGlmaWVycywgaXQgbWlnaHQgYmUgc2ltcGxlci
B0byBtYWtlIHRoZSBtZXRhZGF0YSBVUk4gcHJlZml4IHNvbWV0
aGluZyBsaWtlIGB1cm46eC1ubW9zOmNhcC1tZXRhOmAiLCJjcm
VhdGVkIjoxNjAzNDkzOTY3Nzg3fX0sImhpc3RvcnkiOlsxODYw
OTU2NjgyLDE2NDIyMzU0MCw1MTE1MjU0OCwtMTQyNTMwMTQ1Mi
wyMDkwODQwMjQ2LC0xNTQ0Mjc3NzEsMjQ4MzE0MzgwLC0xMzg1
OTc4NywtMTAzMDY2MTE0Miw4NjE3NTc2MjEsLTE1NjE2NzQzND
MsLTEzNzk1OTc0NTMsMTk5MTI2NjQ1MCwtNTA0MDI2Njc3LDQx
NjA1NDA4NiwxOTA3Nzk0MDY5LC0xNjg3Mzg0Mjg2LDE4ODc0OT
E5MzgsNjg3Mzc4MDM3LC05OTc0NzQ5OTVdfQ==
-->
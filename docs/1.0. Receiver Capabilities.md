# AMWA BCP-xxx-01: NMOS Receiver Capabilities \[Work In Progress\]

In [IS-04][], a Receiver resource expresses the capabilities of a Receiver through attributes that identify constraints on streams of compatible Senders.

Receivers define a`"transport"` and `"format"`. These attributes express constraints on the related attributes in a Sender and its Flow.

The `"caps"` object is intended as an extensible mechanism to define finer-grained constraints. IS-04 itself defines `"caps"` attributes for `"media_types"` (since v1.1) and, for data Receivers, also  `"event_types"` (since v1.3). Both these attributes express constraints on Flow attributes, as arrays whose elements define the alternatives that are acceptable. In each case, the constraint is satisfied when the Flow matches **any of** the enumerated alternatives.

When `"caps"` contains multiple attributes, i.e. both `"media_types"` and `"event_types"`, the Receiver indicates that it only accepts streams from Senders of Flows that satisfy **all of** - both - the constraints.

This specification defines a new `"constraint_sets"` attribute for the Receiver `"caps"` object, which can also be combined with the existing ones. In common with the existing attributes, its value is an array of alternatives; this constraint is satisfied when **any of** its enumerated Constraint Sets are satisfied.

This specification defines a generic JSON syntax to express Constraint Sets made up of individual Parameter Constraints. The Constraint Set is satisfied if **all of** the Parameter Constraints are satisfied.

The representation of Parameter Constraints is consistent with the mechanism defined by [IS-05][] to constrain Sender and Receiver transport parameters at the **/constraints** endpoints, which Nodes and Controllers may also support.

The `"constraints_set"` attribute is listed in the Capabilities parameter register in [NMOS Parameter Registers][].

## Use of Normative Language

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [RFC 2119][RFC-2119].

## Defining Parameter Constraints

A specification for each Parameter Constraint MUST be listed in the Capabilities register in the [NMOS Parameter Registers][]. Each specification defines a unique identifier, the constraint type, and the target parameter, as follows.

### Parameter Constraint Identifiers

Each Parameter Constraint is given a unique identifier - a URN. Parameter Constraints defined by the AMWA have the form:
```
urn:x-nmos:cap:<category>:<constraint>
```

Two `<category>` names are initially defined, `format` for media-related constraints, and `transport` for transport-specific constraints.

For example, `urn:x-nmos:cap:format:grain_rate` is a Parameter Constraint related to the Grain rate of the stream, for example by targeting the  `grain_rate` attribute of an IS-04 Flow. (The concept of Grains is defined in the [JT-NM Reference Architecture][].)

The `<category>` name `meta` is reserved for [metadata related to Constraint Sets](#constraint-set-metadata).

### Parameter Constraint Types

The specification defines the JSON value type of the constraint which MUST be one of:
  * `string`
  * `integer`
  * `number`
  * `boolean`
  * `rational`
    * as per IS-04, a JSON object with an integer `"numerator"` and optional integer `"denominator"` (default: 1)
  * (TBC whether necessary) `array`
  * (TBC whether necessary) `object`

The type of the constraint defines which [Constraint Keywords](#constraint-keywords) are allowed when the Parameter Constraint is instantiated.

### Parameter Constraint Target

The specification defines the target parameter against which the constraint is to be evaluated, for example, the specific IS-04 Flow attribute or [SDP][] format-specific parameter.

Especially in the case of parameters carried in non-JSON formats, such as a transport file, the specification MUST also describe how to map the parameter value to one of the [supported JSON types](#parameter-constraint-types).

## Instantiating Parameter Constraints

The Receiver expresses its capabilities with respect to a particular Parameter Constraint by including its unique identifier as an attribute in a [Constraint Set](#constraint-sets) with an object value, the attributes of which depend on the [specified type](#parameter-constraint-types).

For example:

```json
"urn:x-nmos:cap:format:bit_depth": {
  "enum": [ 24, 20, 16 ]
}
```

## Constraint Keywords

### Common Constraint Keywords

The following attributes are allowed for all constraint types:
* (TBC whether necessary by prototyping activity) `type`, indicating the [specified type](#parameter-constraint-types) as a string value
* `enum` as an array value with one or more elements of the specified type
* (TBC) any means to indicate whether `null` or missing is acceptable?

### String Constraint Keywords

The following attribute is additionally allowed for `string` constraints:

* (TBC) `pattern`, a string value that is a regex pattern

### Integer and Number Constraint Keywords

The following attributes are additionally allowed for `integer` and `number` constraints:

* `minimum`, inclusive minimum, integer or number as appropriate
* `maximum`, inclusive maximum, an integer or number as appropriate

### Boolean Constraint Keywords

Nothing additional

### Rational Constraint Keywords

The following attributes are additionally allowed for `rational` constraints:

* `minimum`, inclusive minimum, `rational` value
* `maximum`, inclusive maximum, `rational` value

### Array Constraint Keywords
(TBC)

The following attributes are additionally allowed for `array` constraints:

* `minItems`, inclusive minimum number of elements, integer
* `maxItems`, inclusive maximum number of elements, integer
* `numItems`, acceptable numbers of elements, array of integer
* `items`, a Parameter Constraint which all elements must satisfy, or an array of Parameter Constraints which must be satisfied one-to-one
* `contains`, a Parameter Constraint which must be satisfied by one or more elements

### Object Constraint Keywords
(TBC)

* `properties` to constrain specific attributes of the object?

## Constraint Sets

Constraint Sets are instantiated with one or more Parameter Constraints. The Constraint Set is satisfied if **all of** the Parameter Constraints are satisfied.

The Constraint Set is represented as a JSON object whose attributes are the Parameter Constraints.

The Receiver advertises a list of Constraint Sets as a JSON array of these objects, using the key `"constraint_sets"` in the `"caps"` object.

A [worked example](#worked-example) is given below.

(TBC) Should we permit Parameter Constraints that would be identical in all Constraint Sets to be as top-level `"caps"` attributes?

### Constraint Set Metadata

Additional metadata about each Constraint Set may be included using attributes listed in the Capabilities register in the [NMOS Parameter Registers][] with the following unique identifiers:
```
urn:x-nmos:cap:meta:<attribute>
```

For example, `urn:x-nmos:cap:meta:label` may be used to provide a human-readable name for the Constraint Set.

The identifier `urn:x-nmos:cap:meta:quality` enables the Receiver to indicate the relative quality of its listed Constraint Sets.

...

## Validating Parameter Constraints and Constraint Sets

This specification includes a JSON Schema for each [Parameter Constraint Type](#parameter-constraint-type) and for Constraint Sets and the `"constraint_sets"` attribute as a whole.

## Behaviour: Receivers

Receivers SHOULD express their capabilities as precisely as possible. However, this specification may not be sufficiently expressive to indicate every type of stream that a Receiver can or cannot consume successfully. It is entirely possible that a Receiver may fail to consume a stream even if the Receiver's advertised Constraint Sets indicate that it can.

The value of the `"constraint_sets"` attribute MUST be valid according to this specification. The value of all the Constraint Set attributes MUST be valid according to the relevant specification in the Capabilities register in the [NMOS Parameter Registers][].

The capabilities of a Receiver could change over its lifetime, for example, as a result of reconfiguration by some other means. The Receiver MUST reflect any change in its capabilities by updating the `"caps"` object as appropriate and [modifying the `"version"` attribute, as per IS-04](https://amwa-tv.github.io/nmos-discovery-registration/tags/v1.3/docs/2.1._APIs_-_Common_Keys.html#version).

...

## Behaviour: Controllers

Controllers MAY validate a Receiver's `"constraint_sets"` against the JSON schema included in this specification, before evaluating the Constraint Sets. Controllers MAY ignore the entire `"constraint_sets"` value if it does not match the schema.

Controllers are RECOMMENDED to evaluate only those Parameter Constraints whose unique identifiers they recognize.

...

## Worked Examples

### HD Video Receiver

A Receiver of ST 2110-20 Video with limited support for various frame rates:

```json
{
  ...
  "transport": "urn:x-nmos:transport:rtp",
  "format": "urn:x-nmos:format:video",
  "caps": {
    "media_types": [ "video/raw" ],
    "constraint_sets": [
      {
        "urn:x-nmos:cap:meta:label": "1080i",
        "urn:x-nmos:cap:format:color_sampling": {
          "enum": [ "YCbCr-4:2:2" ]
        },
        "urn:x-nmos:cap:format:frame_height": {
          "enum": [ 1080 ]
        },
        "urn:x-nmos:cap:format:frame_width": {
          "enum": [ 1920 ]
        },
        "urn:x-nmos:cap:format:grain_rate": {
          "enum": [
             { "numerator": 25 },
             { "numerator": 30000, "denominator": 1001 }
           ]
        },
        "urn:x-nmos:cap:format:interlace_mode": {
          "enum": [
            "interlaced_tff",
            "interlaced_bff",
            "interlaced_psf"
          ]
        }
      },
      {
        "urn:x-nmos:cap:meta:label": "1080p",
        "urn:x-nmos:cap:format:color_sampling": {
          "enum": [ "YCbCr-4:2:2" ]
        },
        "urn:x-nmos:cap:format:frame_height": {
          "enum": [ 1080 ]
        },
        "urn:x-nmos:cap:format:frame_width": {
          "enum": [ 1920 ]
        },
        "urn:x-nmos:cap:format:grain_rate": {
          "enum": [
             { "numerator": 25 },
             { "numerator": 30000, "denominator": 1001 },
             { "numerator": 50 },
             { "numerator": 60000, "denominator": 1001 }
           ]
        },
        "urn:x-nmos:cap:format:interlace_mode": {
          "enum": [ "progressive" ]
        }
      }
    ]
  }
}
```

[IS-04]: https://amwa-tv.github.io/nmos-discovery-registration/ "AMWA IS-04 NMOS Discovery and Registration Specification"

[IS-05]: https://amwa-tv.github.io/nmos-device-connection-management/ "AMWA IS-05 NMOS Device Connection Management Specification"

[JT-NM Reference Architecture]: https://jt-nm.org/RA-1.0/ "JT-NM Reference Architecture (RA) v1.0"

[NMOS Parameter Registers]: https://amwa-tv.github.io/nmos-parameter-registers "Common parameter values for AMWA NMOS Specifications"

[RFC-2119]: https://tools.ietf.org/html/rfc2119 "Key words for use in RFCs to Indicate Requirement Levels"

[SDP]: https://tools.ietf.org/html/rfc4566 "SDP: Session Description Protocol"

<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJTVjMyamRabEZ2S1dHZDE0Ijp7In
RleHQiOiIqIGBwYXR0ZXJuYCIsInN0YXJ0Ijo1MDQ0LCJlbmQi
OjUxMDF9LCJIRWF1Q1NGSE8xYUpDeUdkIjp7InRleHQiOiIjIy
MgQXJyYXkgQ29uc3RyYWludHMiLCJzdGFydCI6NTYzNywiZW5k
Ijo1NjY2fSwiU3Zwd0RVd0JrY3VSZU1zUiI6eyJ0ZXh0IjoiIy
MjIE9iamVjdCBDb25zdHJhaW50cyIsInN0YXJ0Ijo2MTU4LCJl
bmQiOjYxODh9LCJrSUc3dTdpczBoNk40VWhUIjp7InRleHQiOi
IqIGluY2x1ZGUgZXhwbGljaXQgYHR5cGVgIG9yIG5vdD8iLCJz
dGFydCI6NDY1MywiZW5kIjo0Nzg5fSwia01kWllKWkh3UUpWbE
xROCI6eyJ0ZXh0IjoiKiBgYXJyYXlgXG4gICogYG9iamVjdGAi
LCJzdGFydCI6MzQ1NCwiZW5kIjozNTI0fSwiRmVBNHh1SDRQNU
hmeWJ5cCI6eyJ0ZXh0IjoiXCJtZWRpYV90eXBlc1wiOiBbIFwi
dmlkZW8vcmF3XCIgXSwiLCJzdGFydCI6OTI5NCwiZW5kIjo5Mz
I1fSwialdPUjdrZzk3WG1qZDRZdSI6eyJ0ZXh0IjoiVGhlIGlk
ZW50aWZpZXIgYHVybjp4LW5tb3M6Y2FwczptZXRhOnF1YWxpdH
lgIiwic3RhcnQiOjcyNDEsImVuZCI6NzI4NX19LCJjb21tZW50
cyI6eyJWTVA4YThaRE83RkhCSEJaIjp7ImRpc2N1c3Npb25JZC
I6IlNWMzJqZFpsRnZLV0dkMTQiLCJzdWIiOiJnaDozMTc2MTE1
OCIsInRleHQiOiJOb3RlOiBgbWluTGVuZ3RoYCBhbmQgYG1heE
xlbmd0aGAgY2FuIGJlIGFjY29tcGxpc2hlZCB3aXRoIHJlZ2V4
IGBwYXR0ZXJuYCIsImNyZWF0ZWQiOjE2MDI3NTg1OTg3MDZ9LC
JOeFM1bFBNbmZPb09DNkVsIjp7ImRpc2N1c3Npb25JZCI6IkhF
YXVDU0ZITzFhSkN5R2QiLCJzdWIiOiJnaDozMTc2MTE1OCIsIn
RleHQiOiJCZXlvbmQgc2NvcGUgZW50aXJlbHk/IE9yIGFsbG93
IHNvbWUgb3IgYWxsIG9mIHRoZXNlIGF0dHJpYnV0ZXM/IiwiY3
JlYXRlZCI6MTYwMjc2MDc5MDc2OH0sIkpjVG9XVDVTRnJ2d21O
UEEiOnsiZGlzY3Vzc2lvbklkIjoiU3Zwd0RVd0JrY3VSZU1zUi
IsInN1YiI6ImdoOjMxNzYxMTU4IiwidGV4dCI6IkJleW9uZCBz
Y29wZSBvciBub3Q/IiwiY3JlYXRlZCI6MTYwMjc2MDgwNzMzMn
0sIk1rbWpIcmxYQ0t4Yk5CWGoiOnsiZGlzY3Vzc2lvbklkIjoi
a0lHN3U3aXMwaDZONFVoVCIsInN1YiI6ImdoOjMxNzYxMTU4Ii
widGV4dCI6Ik9wZW4gcXVlc3Rpb24gLSBpZiBDb250cm9sbGVy
cyBhcmUgUkVDT01NRU5ERUQgdG8gaWdub3JlIHBhcmFtZXRlci
Bjb25zdHJhaW50cyB0aGV5IGRvbid0IHJlY29nbml6ZSwgd2h5
IGlzIGl0IG5lY2Vzc2FyeT8iLCJjcmVhdGVkIjoxNjAyNzYwOD
U5NzI1fSwiTFhvMFphbHFWTzJXR3E3biI6eyJkaXNjdXNzaW9u
SWQiOiJrTWRaWUpaSHdRSlZsTFE4Iiwic3ViIjoiZ2g6MzE3Nj
ExNTgiLCJ0ZXh0IjoiQmV5b25kIHNjb3BlPyBTZWUgYmVsb3cu
Li4iLCJjcmVhdGVkIjoxNjAyNzYxMDI4OTMxfSwiQVhoOWZPam
c2ZHBKNngyZiI6eyJkaXNjdXNzaW9uSWQiOiJGZUE0eHVINFA1
SGZ5YnlwIiwic3ViIjoiZ2g6NzE1NDIxIiwidGV4dCI6IldoaW
xzdCBJIGNhbiBzZWUgdGhpcyBiZWluZyB1c2VmdWwgZm9yIGJh
Y2t3YXJkcyBjb21wYXRpYmlsaXR5LCBJIGRvIHdvbmRlciBpZi
BhIGNsaWVudCB3aGljaCBvYnNlcnZlcyAndXJuOngtbm1vczpj
YXBzJyBiZWluZyBwcmVzZW50IGNvdWxkIGlnbm9yZSB0aGlzIG
VudGlyZWx5IGFuZCB1c2UgcHVyZWx5IHRoZSBuZXcgY2FwcyBm
b3JtYXQgaW4gcHJlZmVyZW5jZT8gVGhhdCB3YXkgdGhlIG1lZG
lhX3R5cGVzIGNvdWxkIGJlIHRpZWQgdG8gb3RoZXIgY2FwcyBy
YXRoZXIgdGhhbiBhcHBseWluZyBnbG9iYWxseSBhY3Jvc3MgdG
hlbS4iLCJjcmVhdGVkIjoxNjAyODM5NDUzNzE0fSwid0w2cDZF
Q1Z5N0trR3J1dyI6eyJkaXNjdXNzaW9uSWQiOiJqV09SN2tnOT
dYbWpkNFl1Iiwic3ViIjoiZ2g6MzE3NjExNTgiLCJ0ZXh0Ijoi
U2VlIGRpc2N1c3Npb24gYWJvdXQgdXNpbmcgXCJwcmlcIiBvci
BcInByZWZcIiBvciBzb21ldGhpbmcgc2ltaWxhci4uLiIsImNy
ZWF0ZWQiOjE2MDMxMTA4NDQ3NjJ9LCJIVmd6M0pKQ2VDSkNRcl
dXIjp7ImRpc2N1c3Npb25JZCI6ImtJRzd1N2lzMGg2TjRVaFQi
LCJzdWIiOiJnaDozMTc2MTE1OCIsInRleHQiOiJKdXN0IGluY2
x1ZGUgdGhlIHR5cGUgaW4gdGhlIHNwZWNpZmljYXRpb24gaW4g
dGhlIFBhcmFtZXRlciBSZWdpc3RlcnMiLCJjcmVhdGVkIjoxNj
AzMTExNDY3ODY4fSwiU2JVc1ZreDhoUm5XeEozcSI6eyJkaXNj
dXNzaW9uSWQiOiJGZUE0eHVINFA1SGZ5YnlwIiwic3ViIjoiZ2
g6MzE3NjExNTgiLCJ0ZXh0IjoiSSdkIHJhdGhlciBrZWVwIHRo
ZSBydWxlIHRoYXQgYWxsIGNvbnN0cmFpbnRzIGF0IHRoZSB0b3
AgbGV2ZWwgb2YgYFwiY2Fwc1wiYCBtdXN0IGJlIHNhdGlzZmll
ZC4gVGhlIGBcInVybjp4LW5tb3M6Y2FwOmZsb3c6bWVkaWFfdH
lwZVwiYCBjb25zdHJhaW50IGFsbG93cyBDb25zdHJhaW50IFNl
dHMgdG8gYmUgdGllZCB0byBzcGVjaWZpYyBtZWRpYSB0eXBlcz
8iLCJjcmVhdGVkIjoxNjAzMzU5Mzg0NjUxfSwiS2wwQm9IYXgy
ZUNQQ3EzZyI6eyJkaXNjdXNzaW9uSWQiOiJGZUE0eHVINFA1SG
Z5YnlwIiwic3ViIjoiZ2g6NzE1NDIxIiwidGV4dCI6Illlcywg
d2l0aCB0aGUgcHJvdmlzaW9uIHRoYXQgeW91IGFyZSBwZXJtaX
R0ZWQgdG8gdXNlIGB1cm46eC1ubW9zOmNhcDpmbG93Om1lZGlh
X3R5cGVgIGFsb25nc2lkZSB0aGUgdG9wIGxldmVsIGBtZWRpYV
90eXBlc2AgdGhhdCBzb3VuZHMgZmluZS4iLCJjcmVhdGVkIjox
NjAzNDU4NjkxNjkzfX0sImhpc3RvcnkiOlstMjAxMzIzMzM3NS
wtMTQyNTMwMTQ1MiwyMDkwODQwMjQ2LC0xNTQ0Mjc3NzEsMjQ4
MzE0MzgwLC0xMzg1OTc4NywtMTAzMDY2MTE0Miw4NjE3NTc2Mj
EsLTE1NjE2NzQzNDMsLTEzNzk1OTc0NTMsMTk5MTI2NjQ1MCwt
NTA0MDI2Njc3LDQxNjA1NDA4NiwxOTA3Nzk0MDY5LC0xNjg3Mz
g0Mjg2LDE4ODc0OTE5MzgsNjg3Mzc4MDM3LC05OTc0NzQ5OTUs
LTIwNDc3MDIzMzIsNTc5MzEwMjEyXX0=
-->
# AMWA BCP-xxx-01: NMOS Receiver Capabilities \[Work In Progress\]

In [IS-04][], a Receiver resource expresses the capabilities of a Receiver through attributes that identify constraints on streams of compatible Senders.

Receivers define a`"transport"` and `"format"`. These attributes express constraints on the related attributes in a Sender and its Flow.

The `"caps"` object is intended as an extensible mechanism to define finer-grained constraints. IS-04 itself defines `"caps"` attributes for `"media_types"` (since v1.1) and, for data Receivers, also  `"event_types"` (since v1.3). Both these attributes express constraints on Flow attributes, as arrays whose elements define the alternatives that are acceptable. In each case, the constraint is satisfied when the Flow matches **any of** the enumerated alternatives.

When `"caps"` contains multiple attributes, i.e. both `"media_types"` and `"event_types"`, the Receiver indicates that it only accepts streams from Senders of Flows that satisfy **all of** - both - the constraints.

This specification defines a new `"constraint_sets"` attribute for the Receiver `"caps"` object, which can also be combined with the existing ones. In common with the existing attributes, its value is an array of alternatives; this constraint is satisfied when **any of** its enumerated Constraint Sets are satisfied.

This specification defines a generic JSON syntax to express Constraint Sets made up of individual Parameter Constraints. The Constraint Set is satisfied if **all of** the Parameter Constraints are satisfied.

The representation of Parameter Constraints is consistent with the mechanism defined by [IS-05][] to constrain Sender and Receiver transport parameters at the **/constraints** endpoints, which Nodes and Controllers may also support.

The `"constraints_set"` attribute is listed in the Capabilities parameter register in [NMOS Parameter Registers][].

## Use of Normative Language

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [RFC 2119][RFC-2119].

## Defining Parameter Constraints

A specification for each Parameter Constraint MUST be listed in the Capabilities register in the [NMOS Parameter Registers][]. Each specification defines a unique identifier, the constraint type, and the target parameter, as follows.

### Parameter Constraint Identifiers

Each Parameter Constraint is given a unique identifier - a URN. Parameter Constraints defined by the AMWA have the form:
```
urn:x-nmos:cap:<resource>:<parameter>
```

For example, `urn:x-nmos:cap:flow:grain_rate` is a Parameter Constraint related to the `grain_rate` attribute of an IS-04 Flow.

### Parameter Constraint Types

The specification defines the JSON value type of the constraint which MUST be one of:
  * `string`
  * `integer`
  * `number`
  * `boolean`
  * `rational`
    * as per IS-04, a JSON object with an integer `"numerator"` and optional integer `"denominator"`
  * (TBC whether necessary) `array`
  * (TBC whether necessary) `object`

The type of the constraint defines which [Constraint Keywords](#constraint-keywords) are allowed when the Parameter Constraint is instantiated.

### Parameter Constraint Target

The specification defines the target parameter against which the constraint is to be evaluated, for example, the specific IS-04 Flow attribute or [SDP][] format-specific parameter.

Especially in the case of parameters carried in non-JSON formats, such as a transport file, the specification MUST also describe how to map the parameter value to one of the [supported JSON types](#parameter-constraint-types).

## Instantiating Parameter Constraints

The Receiver expresses its capabilities with respect to a particular Parameter Constraint by including its unique identifier as an attribute in a [Constraint Set](#constraint-sets) with an object value, the attributes of which depend on the [specified type](#parameter-constraint-types).

For example:

```json
"urn:x-nmos:cap:flow:bit_depth": {
  "enum": [ 24, 20, 16 ]
}
```

## Constraint Keywords

### Common Constraint Keywords

The following attributes are allowed for all constraint types:
* (TBC whether necessary by prototyping activity) `type`, indicating the [specified type](#parameter-constraint-types) as a string value
* `enum` as an array value with one or more elements of the specified type
* (TBC) any means to indicate whether `null` or missing is acceptable?

### String Constraint Keywords

The following attribute is additionally allowed for `string` constraints:

* (TBC) `pattern`, a string value that is a regex pattern

### Integer and Number Constraint Keywords

The following attributes are additionally allowed for `integer` and `number` constraints:

* `minimum`, inclusive minimum, integer or number as appropriate
* `maximum`, inclusive maximum, an integer or number as appropriate

### Boolean Constraint Keywords

Nothing additional

### Rational Constraint Keywords

The following attributes are additionally allowed for `rational` constraints:

* `minimum`, inclusive minimum, `rational` value
* `maximum`, inclusive maximum, `rational` value

### Array Constraint Keywords
(TBC)

The following attributes are additionally allowed for `array` constraints:

* `minItems`, inclusive minimum number of elements, integer
* `maxItems`, inclusive maximum number of elements, integer
* `numItems`, acceptable numbers of elements, array of integer
* `items`, a Parameter Constraint which all elements must satisfy, or an array of Parameter Constraints which must be satisfied one-to-one
* `contains`, a Parameter Constraint which must be satisfied by one or more elements

### Object Constraint Keywords
(TBC)

* `properties` to constrain specific attributes of the object?

## Constraint Sets

Constraint Sets are instantiated with one or more Parameter Constraints. The Constraint Set is satisfied if **all of** the Parameter Constraints are satisfied.

The Constraint Set is represented as a JSON object whose attributes are the Parameter Constraints.

The Receiver advertises a list of Constraint Sets as a JSON array of these objects, using the key `"constraint_sets"` in the `"caps"` object.

A [worked example](#worked-example) is given below.

Should we permit common parameter constraints to be extracted to a top-level?

### Constraint Set Metadata

Additional metadata about each Constraint Set may be included using attributes listed in the Capabilities register in the [NMOS Parameter Registers][] with the following unique identifiers:
```
urn:x-nmos:cap:meta:<parameter>
```

For example, `urn:x-nmos:cap:meta:label` may be used to provide a human-readable name for the Constraint Set.

The identifier `urn:x-nmos:cap:meta:quality` enables the Receiver to indicate the relative quality of its listed Constraint Sets.

Etc.

## Validating Parameter Constraints and Constraint Sets

This specification includes a JSON Schema for each [Parameter Constraint Type](#parameter-constraint-type) and for Constraint Sets and the `"constraint_sets"` attribute as a whole.

## Behaviour - Receivers

Receivers SHOULD express their capabilities as precisely as possible. However, this specification may not be sufficiently expressive to indicate every type of stream that a Receiver can or cannot consume successfully. It is entirely possible that a Receiver may fail to consume a stream even if the Receiver's advertised Constraint Sets indicate that it can.

The value of the `"constraint_sets"` attribute MUST be valid according to this specification. The value of all the Constraint Set attributes MUST be valid according to the relevant specification in the Capabilities register in the [NMOS Parameter Registers][].

The capabilities of a Receiver could change over its lifetime, for example, as a result of reconfiguration by some other means. The Receiver MUST reflect any change in its capabilities by updating the `"caps"` object as appropriate and [modifying the `"version"` attribute, as per IS-04](https://amwa-tv.github.io/nmos-discovery-registration/tags/v1.3/docs/2.1._APIs_-_Common_Keys.html#version).

...

## Behaviour - Controllers

Controllers MAY validate a Receiver's `"constraint_sets"` against the JSON schema included in this specification, before evaluating the Constraint Sets. Controllers MAY ignore the entire `"constraint_sets"` value if it does not match the schema.

Controllers are RECOMMENDED to evaluate only those Parameter Constraints whose unique identifiers they recognize.

...

## Worked Examples

### HD Video Receiver

A Receiver of ST 2110-20 Video with limited support for various frame rates:

```json
{
  ...
  "transport": "urn:x-nmos:transport:rtp",
  "format": "urn:x-nmos:format:video",
  "caps": {
    "media_types": [ "video/raw" ],
    "constraint_sets": [
      {
        "urn:x-nmos:cap:meta:label": "1080i",
        "urn:x-nmos:cap:flow:frame_height": {
          "enum": [ 1080 ]
        },
        "urn:x-nmos:cap:flow:frame_width": {
          "enum": [ 1920 ]
        },
        "urn:x-nmos:cap:flow:grain_rate": {
          "enum": [
             { "numerator": 25 },
             { "numerator": 30000, "denominator": 1001 }
           ]
        },
        "urn:x-nmos:cap:flow:interlace_mode": {
          "enum": [
            "interlaced_tff",
            "interlaced_bff",
            "interlaced_psf"
          ]
        }
      },
      {
        "urn:x-nmos:cap:meta:label": "1080p",
        "urn:x-nmos:cap:flow:frame_height": {
          "enum": [ 1080 ]
        },
        "urn:x-nmos:cap:flow:frame_width": {
          "enum": [ 1920 ]
        },
        "urn:x-nmos:cap:flow:grain_rate": {
          "enum": [
             { "numerator": 25 },
             { "numerator": 30000, "denominator": 1001 },
             { "numerator": 50 },
             { "numerator": 60000, "denominator": 1001 }
           ]
        },
        "urn:x-nmos:cap:flow:interlace_mode": {
          "enum": [
            "progressive"
          ]
        }
      }
    ]
  }
}
```

[IS-04]: https://amwa-tv.github.io/nmos-discovery-registration/ "AMWA IS-04 NMOS Discovery and Registration Specification"

[IS-05]: https://amwa-tv.github.io/nmos-device-connection-management/ "AMWA IS-05 NMOS Device Connection Management Specification"

[NMOS Parameter Registers]: https://amwa-tv.github.io/nmos-parameter-registers "Common parameter values for AMWA NMOS Specifications"

[RFC-2119]: https://tools.ietf.org/html/rfc2119 "Key words for use in RFCs to Indicate Requirement Levels"

[SDP]: https://tools.ietf.org/html/rfc4566 "SDP: Session Description Protocol"

<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJTVjMyamRabEZ2S1dHZDE0Ijp7In
RleHQiOiIqIGBwYXR0ZXJuYCIsInN0YXJ0Ijo0NjQ0LCJlbmQi
OjQ3MDF9LCJIRWF1Q1NGSE8xYUpDeUdkIjp7InRleHQiOiIjIy
MgQXJyYXkgQ29uc3RyYWludHMiLCJzdGFydCI6NTIzNywiZW5k
Ijo1MjY2fSwiU3Zwd0RVd0JrY3VSZU1zUiI6eyJ0ZXh0IjoiIy
MjIE9iamVjdCBDb25zdHJhaW50cyIsInN0YXJ0Ijo1NzU4LCJl
bmQiOjU3ODh9LCJrSUc3dTdpczBoNk40VWhUIjp7InRleHQiOi
IqIGluY2x1ZGUgZXhwbGljaXQgYHR5cGVgIG9yIG5vdD8iLCJz
dGFydCI6NDI1MywiZW5kIjo0Mzg5fSwia01kWllKWkh3UUpWbE
xROCI6eyJ0ZXh0IjoiKiBgYXJyYXlgXG4gICogYG9iamVjdGAi
LCJzdGFydCI6MzA1NiwiZW5kIjozMTI2fSwidmdjaWpNVDdMWU
R0OTZGOSI6eyJ0ZXh0IjoiPHNvdXJjZT4iLCJzdGFydCI6MjYw
OSwiZW5kIjoyNjE5fSwiRmVBNHh1SDRQNUhmeWJ5cCI6eyJ0ZX
h0IjoiXCJtZWRpYV90eXBlc1wiOiBbIFwidmlkZW8vcmF3XCIg
XSwiLCJzdGFydCI6ODg0MywiZW5kIjo4ODc0fSwialdPUjdrZz
k3WG1qZDRZdSI6eyJ0ZXh0IjoiVGhlIGlkZW50aWZpZXIgYHVy
bjp4LW5tb3M6Y2FwczptZXRhOnF1YWxpdHlgIiwic3RhcnQiOj
Y3ODcsImVuZCI6NjgzMX0sIkVTdm1MWmtJMlpna1NVbmUiOnsi
dGV4dCI6IldvcmsgSW4gUHJvZ3Jlc3NcXCIsInN0YXJ0Ijo0OC
wiZW5kIjo2NX19LCJjb21tZW50cyI6eyJWTVA4YThaRE83RkhC
SEJaIjp7ImRpc2N1c3Npb25JZCI6IlNWMzJqZFpsRnZLV0dkMT
QiLCJzdWIiOiJnaDozMTc2MTE1OCIsInRleHQiOiJOb3RlOiBg
bWluTGVuZ3RoYCBhbmQgYG1heExlbmd0aGAgY2FuIGJlIGFjY2
9tcGxpc2hlZCB3aXRoIHJlZ2V4IGBwYXR0ZXJuYCIsImNyZWF0
ZWQiOjE2MDI3NTg1OTg3MDZ9LCJOeFM1bFBNbmZPb09DNkVsIj
p7ImRpc2N1c3Npb25JZCI6IkhFYXVDU0ZITzFhSkN5R2QiLCJz
dWIiOiJnaDozMTc2MTE1OCIsInRleHQiOiJCZXlvbmQgc2NvcG
UgZW50aXJlbHk/IE9yIGFsbG93IHNvbWUgb3IgYWxsIG9mIHRo
ZXNlIGF0dHJpYnV0ZXM/IiwiY3JlYXRlZCI6MTYwMjc2MDc5MD
c2OH0sIkpjVG9XVDVTRnJ2d21OUEEiOnsiZGlzY3Vzc2lvbklk
IjoiU3Zwd0RVd0JrY3VSZU1zUiIsInN1YiI6ImdoOjMxNzYxMT
U4IiwidGV4dCI6IkJleW9uZCBzY29wZSBvciBub3Q/IiwiY3Jl
YXRlZCI6MTYwMjc2MDgwNzMzMn0sIk1rbWpIcmxYQ0t4Yk5CWG
oiOnsiZGlzY3Vzc2lvbklkIjoia0lHN3U3aXMwaDZONFVoVCIs
InN1YiI6ImdoOjMxNzYxMTU4IiwidGV4dCI6Ik9wZW4gcXVlc3
Rpb24gLSBpZiBDb250cm9sbGVycyBhcmUgUkVDT01NRU5ERUQg
dG8gaWdub3JlIHBhcmFtZXRlciBjb25zdHJhaW50cyB0aGV5IG
Rvbid0IHJlY29nbml6ZSwgd2h5IGlzIGl0IG5lY2Vzc2FyeT8i
LCJjcmVhdGVkIjoxNjAyNzYwODU5NzI1fSwiTFhvMFphbHFWTz
JXR3E3biI6eyJkaXNjdXNzaW9uSWQiOiJrTWRaWUpaSHdRSlZs
TFE4Iiwic3ViIjoiZ2g6MzE3NjExNTgiLCJ0ZXh0IjoiQmV5b2
5kIHNjb3BlPyBTZWUgYmVsb3cuLi4iLCJjcmVhdGVkIjoxNjAy
NzYxMDI4OTMxfSwiNVZ0cFpoRFEyM3A3SkNkaSI6eyJkaXNjdX
NzaW9uSWQiOiJ2Z2Npak1UN0xZRHQ5NkY5Iiwic3ViIjoiZ2g6
NzE1NDIxIiwidGV4dCI6IlBlcmhhcHMgJ3Jlc291cmNlJyB0by
Bhdm9pZCBjb25mdXNpb24gd2l0aCAnU291cmNlJz8iLCJjcmVh
dGVkIjoxNjAyODM5MzM4OTEyfSwiQVhoOWZPamc2ZHBKNngyZi
I6eyJkaXNjdXNzaW9uSWQiOiJGZUE0eHVINFA1SGZ5YnlwIiwi
c3ViIjoiZ2g6NzE1NDIxIiwidGV4dCI6IldoaWxzdCBJIGNhbi
BzZWUgdGhpcyBiZWluZyB1c2VmdWwgZm9yIGJhY2t3YXJkcyBj
b21wYXRpYmlsaXR5LCBJIGRvIHdvbmRlciBpZiBhIGNsaWVudC
B3aGljaCBvYnNlcnZlcyAndXJuOngtbm1vczpjYXBzJyBiZWlu
ZyBwcmVzZW50IGNvdWxkIGlnbm9yZSB0aGlzIGVudGlyZWx5IG
FuZCB1c2UgcHVyZWx5IHRoZSBuZXcgY2FwcyBmb3JtYXQgaW4g
cHJlZmVyZW5jZT8gVGhhdCB3YXkgdGhlIG1lZGlhX3R5cGVzIG
NvdWxkIGJlIHRpZWQgdG8gb3RoZXIgY2FwcyByYXRoZXIgdGhh
biBhcHBseWluZyBnbG9iYWxseSBhY3Jvc3MgdGhlbS4iLCJjcm
VhdGVkIjoxNjAyODM5NDUzNzE0fSwiRzFyODJhSFpUZVY3cXlx
aCI6eyJkaXNjdXNzaW9uSWQiOiJ2Z2Npak1UN0xZRHQ5NkY5Ii
wic3ViIjoiZ2g6MzE3NjExNTgiLCJ0ZXh0IjoiWWVzLCB0aGF0
J3MgYmV0dGVyLiIsImNyZWF0ZWQiOjE2MDMxMDkyMDcwNDZ9LC
J3TDZwNkVDVnk3S2tHcnV3Ijp7ImRpc2N1c3Npb25JZCI6ImpX
T1I3a2c5N1htamQ0WXUiLCJzdWIiOiJnaDozMTc2MTE1OCIsIn
RleHQiOiJTZWUgZGlzY3Vzc2lvbiBhYm91dCB1c2luZyBcInBy
aVwiIG9yIFwicHJlZlwiIG9yIHNvbWV0aGluZyBzaW1pbGFyLi
4uIiwiY3JlYXRlZCI6MTYwMzExMDg0NDc2Mn0sIkhWZ3ozSkpD
ZUNKQ1FyV1ciOnsiZGlzY3Vzc2lvbklkIjoia0lHN3U3aXMwaD
ZONFVoVCIsInN1YiI6ImdoOjMxNzYxMTU4IiwidGV4dCI6Ikp1
c3QgaW5jbHVkZSB0aGUgdHlwZSBpbiB0aGUgc3BlY2lmaWNhdG
lvbiBpbiB0aGUgUGFyYW1ldGVyIFJlZ2lzdGVycyIsImNyZWF0
ZWQiOjE2MDMxMTE0Njc4Njh9LCJTYlVzVmt4OGhSbld4SjNxIj
p7ImRpc2N1c3Npb25JZCI6IkZlQTR4dUg0UDVIZnlieXAiLCJz
dWIiOiJnaDozMTc2MTE1OCIsInRleHQiOiJJJ2QgcmF0aGVyIG
tlZXAgdGhlIHJ1bGUgdGhhdCBhbGwgY29uc3RyYWludHMgYXQg
dGhlIHRvcCBsZXZlbCBvZiBgXCJjYXBzXCJgIG11c3QgYmUgc2
F0aXNmaWVkLiBUaGUgYFwidXJuOngtbm1vczpjYXA6Zmxvdzpt
ZWRpYV90eXBlXCJgIGNvbnN0cmFpbnQgYWxsb3dzIENvbnN0cm
FpbnQgU2V0cyB0byBiZSB0aWVkIHRvIHNwZWNpZmljIG1lZGlh
IHR5cGVzPyIsImNyZWF0ZWQiOjE2MDMzNTkzODQ2NTF9LCJDRV
l1RzNMMDlXZVVMNWR1Ijp7ImRpc2N1c3Npb25JZCI6IkVTdm1M
WmtJMlpna1NVbmUiLCJzdWIiOiJnaDo2NDQxMDExOSIsInRleH
QiOiJUZXN0IGNvbW1lbnQgLSB3cml0dGVuIHdpdGhvdXQgbG9n
Z2luZyBpbnRvIEdvb2dsZSIsImNyZWF0ZWQiOjE2MDMzODA5OT
MyMzZ9LCJsdWR6OEt4R1ZyNVFHTTZ0Ijp7ImRpc2N1c3Npb25J
ZCI6IkVTdm1MWmtJMlpna1NVbmUiLCJzdWIiOiJnaDoyMjc2Nj
I0OCIsInRleHQiOiJBbm90aGVyIHRlc3QgY29tbWVudCAoYnV0
IEkgZGlkIGxvZyBpbnRvIEdvb2dsZSkiLCJjcmVhdGVkIjoxNj
AzMzkyMjI5OTUwfSwiVVdJUHNTZEFkZXVtaGx3VCI6eyJkaXNj
dXNzaW9uSWQiOiJFU3ZtTFprSTJaZ2tTVW5lIiwic3ViIjoiZ2
g6MzE3NjExNTgiLCJ0ZXh0IjoiQW5vdGhlciB0ZXN0IGNvbW1l
bnQiLCJjcmVhdGVkIjoxNjAzNDQzMDI0MTAwfSwiYzRxOFNJQm
lGV0dycjlLdyI6eyJkaXNjdXNzaW9uSWQiOiJFU3ZtTFprSTJa
Z2tTVW5lIiwic3ViIjoiZ2g6NjQ0MTAxMTkiLCJ0ZXh0IjoiSS
BzZWUgeW91ciB0ZXN0IGNvbW1lbnRzIGFuZCByYWlzZSB5b3Ug
dGVuIiwiY3JlYXRlZCI6MTYwMzQ0MzQ1ODY3N30sIktsMEJvSG
F4MmVDUENxM2ciOnsiZGlzY3Vzc2lvbklkIjoiRmVBNHh1SDRQ
NUhmeWJ5cCIsInN1YiI6ImdoOjcxNTQyMSIsInRleHQiOiJZZX
MsIHdpdGggdGhlIHByb3Zpc2lvbiB0aGF0IHlvdSBhcmUgcGVy
bWl0dGVkIHRvIHVzZSBgdXJuOngtbm1vczpjYXA6ZmxvdzptZW
RpYV90eXBlYCBhbG9uZ3NpZGUgdGhlIHRvcCBsZXZlbCBgbWVk
aWFfdHlwZXNgIHRoYXQgc291bmRzIGZpbmUuIiwiY3JlYXRlZC
I6MTYwMzQ1ODY5MTY5M319LCJoaXN0b3J5IjpbMjA5MDg0MDI0
NiwtMTU0NDI3NzcxLDI0ODMxNDM4MCwtMTM4NTk3ODcsLTEwMz
A2NjExNDIsODYxNzU3NjIxLC0xNTYxNjc0MzQzLC0xMzc5NTk3
NDUzLDE5OTEyNjY0NTAsLTUwNDAyNjY3Nyw0MTYwNTQwODYsMT
kwNzc5NDA2OSwtMTY4NzM4NDI4NiwxODg3NDkxOTM4LDY4NzM3
ODAzNywtOTk3NDc0OTk1LC0yMDQ3NzAyMzMyLDU3OTMxMDIxMi
wtMjA0NzcwMjMzMiwyMDQxMTkyOTY0XX0=
-->